<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YouTube Link Organizer</title>
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <!-- Sortable.js for drag-and-drop reordering -->
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <style>
        /* --- Root Variables for Theming --- */
        :root {
            /* Dark Theme Colors (Default values for generic vars) */
            --primary-color: #6200EE; /* Deep Purple */
            --primary-light: #BB86FC; /* Lighter Purple */
            --secondary-color: #03DAC6; /* Teal */
            --error-color: #CF6679; /* Red */

            --bg-color: #121212; /* Dark background */
            --surface-color: #1F1F1F; /* Dark surfaces */
            --text-color: #E0E0E0; /* Light text */
            --text-muted-color: #A0A0A0; /* Muted light text */
            --border-color: #333333; /* Dark border */

            --card-shadow: rgba(0, 0, 0, 0.4);
            --modal-shadow: rgba(0, 0, 0, 0.5);
            --input-focus-shadow: rgba(98, 0, 238, 0.5); /* primary-color with transparency */
            --youtube-thumbnail-border: transparent; /* Thumbnail border in dark mode */
            --three-dots-color: #777; /* Default color for 3-dots icon */
            --three-dots-hover-bg: rgba(255, 255, 255, 0.1);

            /* Note Button Colors for Dark Theme (Icon specific) */
            /* Add Note: Transparent background, muted text for border/icon */
            --note-add-bg: transparent;
            --note-add-text: var(--text-muted-color);
            /* Open Note: Solid Teal, white icon */
--note-open-bg: #000000; /* Solid Black */
--note-open-text: white; /* White icon */
--note-open-hover-bg: var(--secondary-color); /* Teal for hover */

            /* Card Size Variable (controlled by slider) */
            --card-base-width: 320px; /* Default card width */
        }

        /* --- Light Theme Class --- */
        body.light-theme {
            --bg-color: #F8F8F8; /* Lighter background */
            --surface-color: #FFFFFF;    /* White surfaces */
            --text-color: #333333;        /* Dark text on light backgrounds */
            --text-muted-color: #666666; /* Muted text on light backgrounds */
            --border-color: #E0E0E0;     /* Lighter border */
            --card-shadow: rgba(0, 0, 0, 0.15);
            --modal-shadow: rgba(0, 0, 0, 0.25);
            --input-focus-shadow: rgba(98, 0, 238, 0.3); /* primary-color with transparency */
            --youtube-thumbnail-border: var(--border-color);
            --three-dots-color: #909090;
            --three-dots-hover-bg: rgba(0, 0, 0, 0.05);

            /* Note Button Colors for Light Theme (Icon specific) */
            --note-add-bg: transparent;
            --note-add-text: var(--text-muted-color);
--note-open-bg: #000000; /* Solid Black */
            --note-open-text: white; /* White icon */
            --note-open-hover-bg: #00A38E; /* Darker solid teal for hover */
        }

        /* --- System Theme (prefers light) --- */
        @media (prefers-color-scheme: light) {
            body:not(.dark-theme):not(.light-theme) { /* Only apply if no explicit theme is set */
                --bg-color: #F8F8F8;
                --surface-color: #FFFFFF;
                --text-color: #333333;
                --text-muted-color: #666666;
                --border-color: #E0E0E0;
                --card-shadow: rgba(0, 0, 0, 0.15);
                --modal-shadow: rgba(0, 0, 0, 0.25);
                --input-focus-shadow: rgba(98, 0, 238, 0.3);
                --youtube-thumbnail-border: var(--border-color);
                --three-dots-color: #909090;
                --three-dots-hover-bg: rgba(0, 0, 0, 0.05);

                /* Note Button Colors for System Light Theme */
                --note-add-bg: transparent;
                --note-add-text: var(--text-muted-color);
                --note-open-bg: var(--secondary-color);
                --note-open-text: white;
                --note-open-hover-bg: #00A38E;
            }
        }

        /* --- General Styles --- */
        body {
            font-family: 'Roboto', sans-serif;
            margin: 0;
            background-color: var(--bg-color); 
            color: var(--text-color);           
            transition: background-color 0.3s ease, color 0.3s ease;
            display: flex;
            min-height: 100vh; /* Ensure body takes full height for mobile scroll */
            font-size: 14px; /* Base font size */
        }

        /* Scrollbar styles for better aesthetics */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: var(--surface-color);
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb {
            background: var(--primary-light);
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: var(--primary-color);
        }
        /* Firefox */
        html {
            scrollbar-color: var(--primary-light) var(--surface-color);
            scrollbar-width: thin;
        }

        /* --- App Layout --- */
        .app-container {
            display: flex;
            width: 100%;
            height: 100vh; /* Fixed height to viewport height */
            overflow: hidden; /* Hide overflow for the container, let children manage their scroll */
        }

        /* --- Sidebar --- */
        .sidebar {
            width: 280px;
            min-width: 250px;
            background-color: var(--surface-color);
            box-shadow: 2px 0 8px var(--card-shadow);
            padding: 20px;
            display: flex;
            flex-direction: column;
            z-index: 101;
            height: 96%; /* Changed height as requested */
            overflow-y: hidden; /* Prevent sidebar itself from scrolling */
            transition: background-color 0.3s ease, box-shadow 0.3s ease;
        }

        .sidebar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
            color: var(--primary-color);
        }
        .sidebar-header h2 {
            margin: 0;
            font-size: 1.5em;
        }

        .icon-btn {
            background: var(--primary-color);
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            font-size: 1.8em;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            flex-shrink: 0;
        }
        .icon-btn:hover {
            background-color: var(--primary-light);
            transform: scale(1.05);
        }
        .icon-btn:active {
            transform: scale(0.98);
        }

        .lists-container {
            flex-grow: 1; /* Allow it to take available height */
            overflow-y: auto; /* Make only the lists-container scrollable */
            margin-bottom: 20px;
        }

        .list-item {
            display: block;
            width: 100%;
            padding: 12px 15px;
            margin-bottom: 8px;
            border: none;
            text-align: left;
            background-color: transparent;
            color: var(--text-color);
            font-size: 1.05em;
            cursor: pointer;
            border-radius: 8px;
            transition: background-color 0.2s ease, color 0.2s ease, box-shadow 0.2s ease;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            box-shadow: inset 0 0 0px transparent;
        }
        /* Hover state for non-active list items */
        .list-item:hover:not(.active) { 
            background-color: var(--surface-color); 
            box-shadow: inset 0 0 0px 1px var(--primary-light); 
            color: var(--primary-light); 
        }
        /* Active list item styles */
        .list-item.active {
            background-color: var(--primary-color);
            color: white;
            font-weight: bold;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }
        /* Hover state for active list item */
        .list-item.active:hover { 
            background-color: var(--primary-light);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            color: white; 
        }

        .sidebar-footer {
            padding-top: 20px;
            border-top: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: auto;
        }

        /* Styles for authentication section */
        .auth-controls {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px dashed var(--border-color);
            align-items: center;
        }
        .auth-controls span {
            font-size: 0.9em;
            color: var(--text-muted-color);
            text-align: center;
        }
        .auth-controls button {
            width: 100%; /* Make auth buttons take full width */
            box-sizing: border-box;
            font-weight: normal; /* Override bold for general buttons */
        }
        /* Specific style for Google Sign-in button */
        #sign-in-google-btn {
            background-color: #4285F4; /* Google Blue */
            border-color: #4285F4;
            color: white;
        }
        #sign-in-google-btn:hover {
            background-color: #357ae8;
            border-color: #357ae8;
        }
        /* End Auth Styles */


        .theme-selector label {
            display: block;
            margin-bottom: 5px;
            font-size: 0.9em;
            color: var(--text-muted-color);
        }

        /* --- Main Content Area --- */
        .main-content {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            overflow-y: auto; /* This element itself can scroll if its content overflows */
        }

        header {
            background-color: var(--surface-color);
            padding: 15px 25px;
            box-shadow: 0 2px 5px var(--card-shadow);
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 15px;
            z-index: 100;
            transition: background-color 0.3s ease, box-shadow 0.3s ease;
        }

        header h1 {
            margin: 0;
            font-size: 1.8em;
            color: var(--primary-color);
            text-shadow: 0 0 5px rgba(98, 0, 238, 0.3);
        }

        .controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
        }

        .size-slider-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .size-slider-group label {
            font-size: 0.9em;
            color: var(--text-muted-color);
            white-space: nowrap;
        }
        #card-size-slider {
            width: 120px;
            -webkit-appearance: none;
            appearance: none;
            background: var(--border-color);
            outline: none;
            border-radius: 5px;
            height: 5px;
            cursor: pointer;
        }
        #card-size-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 15px;
            height: 15px;
            border-radius: 50%;
            background: var(--primary-light);
            cursor: grab;
            transition: background 0.2s ease, transform 0.2s ease;
        }
        #card-size-slider::-webkit-slider-thumb:active {
            transform: scale(1.2);
            cursor: grabbing;
        }
        #card-size-slider::-moz-range-thumb {
            width: 15px;
            height: 15px;
            border-radius: 50%;
            background: var(--primary-light);
            cursor: grab;
            transition: background 0.2s ease, transform 0.2s ease;
        }
        #card-size-slider::-moz-range-thumb:active {
            transform: scale(1.2);
            cursor: grabbing;
        }


        select, button, input[type="text"], textarea {
            padding: 10px 15px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            background-color: var(--bg-color);
            color: var(--text-color);
            font-size: 0.9em;
            transition: all 0.3s ease;
            outline: none;
        }

        select:focus, input[type="text"]:focus, textarea:focus {
            border-color: var(--secondary-color);
            box-shadow: 0 0 8px var(--input-focus-shadow);
        }

        button {
            cursor: pointer;
            background-color: var(--primary-color);
            border-color: var(--primary-color);
            font-weight: bold;
            color: white;
        }

        button:hover {
            background-color: var(--primary-light);
            border-color: var(--primary-light);
            color: white; /* Keep white for primary light */
        }

        button.outline {
            background-color: transparent;
            border: 1px solid var(--primary-light);
            color: var(--primary-light);
        }
        button.outline:hover {
            background-color: var(--primary-light);
            color: white; /* Keep white for outline hover */
        }

        button.danger {
            background-color: var(--error-color);
            border-color: var(--error-color);
            color: var(--text-light);
        }
        button.danger:hover {
            background-color: #b00020;
        }

        main {
            flex-grow: 1;
            padding: 20px;
            overflow-y: auto; /* This element itself can scroll if its content overflows */
        }

        /* --- Video Grid Container (CSS Grid) --- */
        #video-grid-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(var(--card-base-width), 1fr));
            gap: 20px;
            justify-items: center;
            align-items: start;
            padding: 10px;
            box-sizing: border-box;
            min-height: 100%;
        }

        /* --- Individual Video Card (YouTube-like) --- */
        .video-card {
            background-color: var(--surface-color);
            border-radius: 8px;
            box-shadow: 0 4px 10px var(--card-shadow);
            overflow: hidden;
            width: 100%; /* Take full width of grid cell */
            max-width: var(--card-base-width); /* Restrict max width */
            display: flex;
            flex-direction: column;
            cursor: pointer;
            transition: box-shadow 0.2s ease, transform 0.1s ease, background-color 0.3s ease;
            list-style: none;
            margin: 0;
        }
        .video-card:hover {
            box-shadow: 0 6px 15px var(--card-shadow);
        }

        /* Sortable.js specific classes */
        .video-card.sortable-ghost {
            opacity: 0.2;
            border: 1px dashed var(--primary-light);
            background-color: transparent;
            box-shadow: none;
        }
        .video-card.sortable-drag {
            opacity: 1;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.5);
            transform: scale(1.02);
            cursor: grabbing;
        }

        .video-card-thumbnail {
            position: relative; /* Crucial for absolute positioning of action buttons */
            width: 100%;
            padding-bottom: 56.25%; /* 16:9 Aspect Ratio */
            overflow: hidden;
            border-bottom: 1px solid var(--youtube-thumbnail-border);
            cursor: grab; /* Enable drag on thumbnail */
        }
        .video-card-thumbnail img {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-top-left-radius: 8px;
            border-top-right-radius: 8px;
        }
        .duration-overlay {
            position: absolute;
            bottom: 8px;
            right: 8px;
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            font-size: 0.75em;
            padding: 2px 6px;
            border-radius: 4px;
            z-index: 1;
        }

        /* --- Action Buttons (Note & Three Dots) --- */
        .video-card-action-buttons {
            position: absolute; /* Position relative to .video-card-thumbnail */
            top: 8px; /* Padding from top */
            right: 8px; /* Padding from right */
            z-index: 2; /* Ensure it's above thumbnail content */
            display: flex;
            flex-direction: column; /* Stack vertically */
            align-items: flex-end; /* Align icons to the right within their column */
            gap: 5px; /* Space between the two icon buttons */

            opacity: 0; /* Hidden by default */
            visibility: hidden; /* Hidden by default */
            transition: opacity 0.2s ease, visibility 0.2s ease; /* Smooth fade */
        }

        /* Show action buttons on hover over the entire video card */
        .video-card:hover .video-card-action-buttons {
            opacity: 1;
            visibility: visible;
        }

        /* Always show action buttons if the video card has a note */
        .video-card.has-note .video-card-action-buttons {
            opacity: 1;
            visibility: visible;
        }


        /* --- Video Card Info Wrapper (Below thumbnail) --- */
        .video-card-info-wrapper {
            display: flex;
            padding: 12px;
            align-items: flex-start;
            gap: 10px;
            position: relative; /* For 3-dots menu overlay positioning */
        }

        .channel-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            object-fit: cover;
            flex-shrink: 0;
            margin-top: 2px;
            background-color: var(--border-color);
        }

        .video-text-content {
            flex-grow: 1;
            overflow: hidden;
            min-width: 0; /* Important for flex items */
            display: flex; /* Made flex to stack children */
            flex-direction: column; /* Stack children vertically */
        }

        .video-text-content h3 {
            font-size: 1.05em;
            margin: 0 0 4px;
            line-height: 1.3;
            max-height: 2.6em;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            color: var(--text-color);
        }

        .video-card-meta {
            line-height: 1.3; /* Adjust line height for meta info */
        }
        .video-card-meta p {
            margin: 0;
            font-size: 0.85em;
            color: var(--text-muted-color);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .video-card-meta p.channel-name {
            font-weight: 500;
            color: var(--text-muted-color);
        }

        /* --- Inline Note Button (Icon Only) --- */
        .inline-note-btn {
            font-family: 'Segoe UI Emoji', 'Noto Color Emoji', 'Apple Color Emoji', sans-serif; /* Ensure emoji renders */
            font-size: 1.5em; /* Larger for icon */
            width: 32px;    /* Fixed width for square button */
            height: 32px;   /* Fixed height for square button */
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 0; /* Remove padding for icon button */
            border-radius: 25%; /* Changed from 50% to 25% */
            cursor: pointer;
            transition: background-color 0.2s ease, color 0.2s ease, border-color 0.2s ease;
            box-sizing: border-box;
        }

        /* "Add Note" button (no note) - simple white and black formatting */
        .inline-note-btn.add-note {
            background-color: transparent; 
            border: 1px solid var(--border-color); 
            color: var(--text-muted-color); 
        }
        .inline-note-btn.add-note:hover {
            background-color: var(--three-dots-hover-bg); 
            color: var(--text-color); 
            border-color: var(--text-color);
        }

        /* "Open Note" button (has note) - colored */
        .inline-note-btn.open-note {
            background-color: var(--note-open-bg); /* Solid teal */
            border: 1px solid var(--secondary-color); 
            color: var(--note-open-text); /* White icon */
        }
        .inline-note-btn.open-note:hover {
            background-color: var(--note-open-hover-bg); /* Darker solid teal */
            color: var(--note-open-text); 
        }
        
        /* --- Three-dot menu button --- */
        .three-dots-menu-btn {
            background: none;
            border: none;
            color: var(--three-dots-color);
            font-size: 1.5em;
            width: 24px;
            height: 24px;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 0;
            /* Margins removed, controlled by parent .video-card-action-buttons gap/flex */
            cursor: pointer;
            border-radius: 50%;
            transition: background-color 0.2s ease, color 0.2s ease; /* Added color transition */
            flex-shrink: 0;
            position: relative; 
        }
        .three-dots-menu-btn:hover {
            background-color: var(--three-dots-hover-bg);
            /* Solid color on hover */
            background-color: var(--surface-color); 
            color: var(--text-color); /* Change icon color on hover */
        }
        /* Specific hover for light theme to ensure dark text on light hover */
        body.light-theme .three-dots-menu-btn:hover,
        @media (prefers-color-scheme: light) {
            body:not(.dark-theme):not(.light-theme) .three-dots-menu-btn:hover {
                background-color: var(--border-color); /* Lighter border for light theme hover */
                color: var(--text-color); /* Dark text on light hover */
            }
        }
        .three-dots-menu-btn:focus {
            outline: 2px solid var(--primary-light);
        }


        .video-menu-overlay {
            position: fixed; 
            background-color: var(--surface-color);
            border-radius: 8px;
            box-shadow: 0 4px 12px var(--card-shadow);
            z-index: 1000; 
            min-width: 150px;
            padding: 8px 0;
            display: none;
            flex-direction: column;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.2s ease, transform 0.2s ease, visibility 0.2s ease;
        }
        .video-menu-overlay.active {
            display: flex;
            opacity: 1;
            visibility: visible;
        }
        .video-menu-overlay button.menu-item {
            display: block;
            width: 100%;
            text-align: left;
            padding: 10px 15px;
            background: none;
            border: none;
            color: var(--text-color);
            font-size: 0.9em;
            cursor: pointer;
            border-radius: 0;
            transition: background-color 0.2s ease;
        }
        .video-menu-overlay button.menu-item:hover {
            background-color: rgba(var(--primary-light), 0.1);
        }
        .video-menu-overlay button.menu-item.danger:hover {
            background-color: rgba(var(--error-color), 0.2);
        }

        /* --- Modals --- */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background-color: var(--surface-color);
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 5px 15px var(--modal-shadow);
            width: 90%;
            max-width: 500px;
            transform: translateY(-20px);
            transition: transform 0.3s ease, background-color 0.3s ease;
            color: var(--text-color);
            position: relative; /* For the close button */
        }

        .modal-overlay.active .modal-content {
            transform: translateY(0);
        }

        .modal-content h2 {
            margin-top: 0;
            color: var(--primary-color);
            font-size: 1.5em;
            text-align: center;
            margin-bottom: 20px;
        }

        .modal-content label {
            display: block;
            margin-bottom: 8px;
            color: var(--text-color);
            font-weight: bold;
        }

        .modal-content input[type="text"],
        .modal-content textarea {
            width: calc(100% - 24px); /* Account for padding */
            margin-bottom: 15px;
        }
        .modal-content textarea {
            min-height: 120px;
            resize: vertical;
        }

        .modal-content .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }

        .modal-content .modal-actions button {
            min-width: 90px;
        }

        /* Close button for modals */
        .modal-close-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            font-size: 1.5em;
            color: var(--text-muted-color);
            cursor: pointer;
            transition: color 0.2s ease;
            padding: 5px;
            line-height: 1;
        }
        .modal-close-btn:hover {
            color: var(--primary-color);
        }

        /* --- Note Modal Video Preview (New) --- */
        .note-modal-video-preview {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            align-items: flex-start;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background-color: var(--bg-color); /* Slightly different from modal surface */
        }

        .note-modal-video-preview-thumbnail {
            width: 120px; /* Fixed small width */
            height: 67.5px; /* 16:9 aspect ratio for 120px width */
            flex-shrink: 0;
            overflow: hidden;
            border-radius: 4px;
            position: relative; /* For duration overlay */
        }
        .note-modal-video-preview-thumbnail img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .note-modal-video-preview-thumbnail .duration-overlay {
            /* Inherit existing duration-overlay styles */
            position: absolute;
            bottom: 4px;
            right: 4px;
            font-size: 0.65em;
            padding: 1px 4px;
        }

        .note-modal-video-preview-info {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            min-width: 0; /* Important for flex-grow to work */
        }
        .note-modal-video-preview-info h3 {
            font-size: 1.1em;
            margin: 0 0 5px;
            line-height: 1.3;
            max-height: 2.6em; /* 2 lines */
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            color: var(--text-color);
        }
        .note-modal-video-preview-info p {
            font-size: 0.8em;
            color: var(--text-muted-color);
            margin: 0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        /* End Note Modal Video Preview */


        /* --- Messages and Loading --- */
        #message-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 10px;
            width: 300px;
            pointer-events: none;
        }

        .message {
            padding: 10px 15px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            font-size: 0.9em;
            opacity: 0;
            transform: translateX(100%);
            transition: opacity 0.3s ease, transform 0.3s ease;
            pointer-events: auto;
        }

        .message.show {
            opacity: 1;
            transform: translateX(0);
        }

        .message.success {
            background-color: #4CAF50;
            color: white;
        }

        .message.error {
            background-color: var(--error-color);
            color: white;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            display: none;
        }

        .loading-overlay.active {
            display: flex;
        }

        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid var(--primary-light);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* --- Media Queries for Responsiveness --- */
        @media (max-width: 992px) {
            .sidebar {
                width: 200px;
                min-width: 180px;
                padding: 15px;
            }
            .sidebar-header h2 {
                font-size: 1.3em;
            }
            .list-item {
                font-size: 1em;
                padding: 10px 12px;
            }
            header h1 {
                font-size: 1.5em;
            }
            .controls {
                gap: 8px;
            }
            select, button, input[type="text"] {
                padding: 8px 12px;
                font-size: 0.85em;
            }
            .video-text-content h3 {
                font-size: 1em;
            }
        }

        @media (max-width: 768px) {
            .app-container {
                flex-direction: column;
                height: auto; 
                overflow: visible; 
            }
            body {
                 min-height: 100vh; 
            }
            .sidebar {
                width: 100%;
                height: auto;
                max-height: 180px; 
                padding: 15px 20px;
                box-shadow: 0 2px 5px var(--card-shadow);
                order: -1;
                border-bottom-left-radius: 0;
                border-bottom-right-radius: 0;
                overflow-y: hidden; 
            }
            .lists-container {
                overflow-y: auto; 
            }
            .sidebar-header {
                justify-content: center;
                margin-bottom: 15px;
                padding-bottom: 10px;
                border-bottom: 1px solid var(--border-color);
                position: relative;
            }
            .sidebar-header h2 {
                flex-grow: 1;
                text-align: center;
            }
            .icon-btn {
                position: absolute;
                right: 20px;
                top: 10px;
                width: 36px;
                height: 36px;
                font-size: 1.5em;
            }
            .lists-container {
                display: flex;
                flex-wrap: wrap;
                gap: 8px;
                justify-content: center;
                margin-bottom: 15px;
            }
            .list-item {
                width: auto;
                margin-bottom: 0;
                padding: 8px 15px;
                font-size: 0.9em;
                flex-shrink: 0;
            }
            .sidebar-footer {
                flex-direction: row;
                justify-content: space-between;
                align-items: center;
                padding-top: 15px;
                margin-top: 0;
            }
            .sidebar-footer button.danger {
                order: 2;
            }
            .theme-selector {
                order: 1;
            }
            .main-content {
                width: 100%;
            }
            header {
                padding: 10px;
                flex-direction: column;
                align-items: flex-start;
                border-top-left-radius: 0;
                border-top-right-radius: 0;
            }
            .controls {
                width: 100%;
                justify-content: center;
                gap: 5px;
            }
            .size-slider-group {
                width: 100%;
                justify-content: center;
            }
            #message-container {
                top: unset;
                bottom: 20px;
                left: 50%;
                transform: translateX(-50%);
                width: 90%;
                max-width: 350px;
                text-align: center;
            }
            #video-grid-container {
                padding: 10px;
            }
            .video-card {
                max-width: 100%;
            }
            .video-card-thumbnail {
                cursor: pointer;
            }
            .video-card.sortable-drag {
                cursor: grabbing;
            }
            /* Action buttons row on small screens */
            .video-card-action-buttons {
                flex-direction: row; 
                justify-content: flex-end;
                gap: 8px;
                width: auto;
                top: 5px; 
                right: 5px;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <h2>Your Lists</h2>
                <button id="create-list-btn" class="icon-btn" title="Create New List">+</button>
            </div>
            <div id="lists-container" class="lists-container">
                <!-- Lists will be dynamically rendered here -->
            </div>
            <div class="sidebar-footer">
                <!-- Authentication Controls -->
                <div class="auth-controls">
                    <span id="auth-status">Checking status...</span>
                    <button id="sign-in-google-btn" style="display: none;">Sign In with Google</button>
                    <button id="sign-out-btn" class="outline" style="display: none;">Sign Out</button>
                </div>
                <!-- End Authentication Controls -->
                
                <button id="delete-list-btn" class="danger" style="display: none;">Delete Current List</button>
                <button id="rename-list-btn" class="outline" style="display: none;">Rename Current List</button>
                <div class="theme-selector">
                    <label for="theme-mode-selector">Theme:</label>
                    <select id="theme-mode-selector">
                        <option value="system">System</option>
                        <option value="dark">Dark</option>
                        <option value="light">Light</option>
                    </select>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <div class="main-content">
            <header>
                <h1>YouTube Link Organizer</h1>
                <div class="controls">
                    <input type="text" id="search-input" placeholder="Search videos...">
                    <div class="size-slider-group">
                        <label for="card-size-slider">Card Size:</label>
                        <input type="range" id="card-size-slider" min="250" max="450" value="320">
                    </div>
                    <button id="add-video-button-header">Add Video</button>
                </div>
            </header>

            <main>
                <div id="video-grid-container">
                    <!-- Video cards will be dynamically loaded here -->
                </div>
            </main>
        </div>
    </div>

    <!-- Modals -->
    <div id="add-video-modal" class="modal-overlay">
        <div class="modal-content">
            <button class="modal-close-btn cancel-btn" title="Close">&times;</button>
            <h2>Add New YouTube Video</h2>
            <label for="video-link-input">YouTube Video URL:</label>
            <input type="text" id="video-link-input" placeholder="e.g., https://www.youtube.com/watch?v=dQw4w9WgXcQ">
            <div class="modal-actions">
                <button class="outline cancel-btn">Cancel</button>
                <button id="submit-video-btn">Add Video</button>
            </div>
        </div>
    </div>

    <div id="create-list-modal" class="modal-overlay">
        <div class="modal-content">
            <button class="modal-close-btn cancel-btn" title="Close">&times;</button>
            <h2>Create New List</h2>
            <label for="list-name-input">List Name:</label>
            <input type="text" id="list-name-input" placeholder="e.g., My Favorites, Tutorials">
            <div class="modal-actions">
                <button class="outline cancel-btn">Cancel</button>
                <button id="submit-list-btn">Create List</button>
            </div>
        </div>
    </div>

    <div id="confirm-delete-modal" class="modal-overlay">
        <div class="modal-content">
            <button class="modal-close-btn cancel-btn" title="Close">&times;</button>
            <h2>Confirm Deletion</h2>
            <p id="confirm-delete-message">Are you sure you want to delete this item?</p>
            <div class="modal-actions">
                <button class="outline cancel-btn">Cancel</button>
                <button id="confirm-delete-btn" class="danger">Delete</button>
            </div>
        </div>
    </div>

    <div id="rename-list-modal" class="modal-overlay">
        <div class="modal-content">
            <button class="modal-close-btn cancel-btn" title="Close">&times;</button>
            <h2>Rename List</h2>
            <label for="rename-list-name-input">New List Name:</label>
            <input type="text" id="rename-list-name-input" placeholder="Enter new list name">
            <div class="modal-actions">
                <button class="outline cancel-btn">Cancel</button>
                <button id="submit-rename-list-btn">Rename</button>
            </div>
        </div>
    </div>

    <!-- New Note Edit Modal -->
    <div id="note-edit-modal" class="modal-overlay">
        <div class="modal-content">
            <button class="modal-close-btn cancel-btn" title="Close">&times;</button>
            <h2 id="note-modal-title">Edit Note</h2>
            <!-- Video Preview section within the note modal -->
            <div id="note-video-details" class="note-modal-video-preview">
                <!-- Video details will be dynamically loaded here -->
            </div>
            <label for="note-textarea-modal">Note Content:</label>
            <textarea id="note-textarea-modal" placeholder="Type your notes here..."></textarea>
            <div class="modal-actions">
                <button class="outline cancel-btn">Cancel</button>
                <button id="delete-note-btn-modal" class="danger">Delete Note</button>
                <button id="save-note-btn-modal">Save Note</button>
            </div>
        </div>
    </div>

    <!-- Message Container -->
    <div id="message-container"></div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loading-overlay">
        <div class="spinner"></div>
    </div>

    <script>
        // --- Firebase Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyAU-lbB1xDIds2tqo8tjnqDdUDq6rbDVm8",
            authDomain: "alamza-a77a9.firebaseapp.com",
            databaseURL: "https://alamza-a77a9-default-rtdb.firebaseio.com",
            projectId: "alamza-a77a9",
            storageBucket: "alamza-a77a9.firebasestorage.app",
            messagingSenderId: "815562116019",
            appId: "1:815562116019:web:09b325349a2d336b2f19c6",
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const auth = firebase.auth();

        // --- YouTube API Configuration ---
        const YOUTUBE_API_KEY = 'AIzaSyAi9TmRbAeBiTxzxtUGoDiyVHOhW63GYNc'; 

        // --- DOM Elements ---
        const videoGridContainer = document.getElementById('video-grid-container');
        const addVideoButtonHeader = document.getElementById('add-video-button-header');
        const addVideoModal = document.getElementById('add-video-modal');
        const videoLinkInput = document.getElementById('video-link-input');
        const submitVideoBtn = document.getElementById('submit-video-btn');

        const listsContainer = document.getElementById('lists-container');
        const createListBtn = document.getElementById('create-list-btn');
        const deleteListBtn = document.getElementById('delete-list-btn');
        const renameListBtn = document.getElementById('rename-list-btn'); // New
        const createListModal = document.getElementById('create-list-modal');
        const listNameInput = document.getElementById('list-name-input');
        const submitListBtn = document.getElementById('submit-list-btn');

        const confirmDeleteModal = document.getElementById('confirm-delete-modal');
        const confirmDeleteMessage = document.getElementById('confirm-delete-message');
        const confirmDeleteBtn = document.getElementById('confirm-delete-btn');

        const renameListModal = document.getElementById('rename-list-modal'); // New
        const renameListNameInput = document.getElementById('rename-list-name-input'); // New
        const submitRenameListBtn = document.getElementById('submit-rename-list-btn'); // New

        const searchInput = document.getElementById('search-input');
        const messageContainer = document.getElementById('message-container');
        const loadingOverlay = document.getElementById('loading-overlay');

        const themeModeSelector = document.getElementById('theme-mode-selector');
        const cardSizeSlider = document.getElementById('card-size-slider'); 

        // Note Modal Elements
        const noteEditModal = document.getElementById('note-edit-modal');
        const noteModalTitle = document.getElementById('note-modal-title');
        const noteVideoDetails = document.getElementById('note-video-details'); 
        const noteTextareaModal = document.getElementById('note-textarea-modal');
        const saveNoteBtnModal = document.getElementById('save-note-btn-modal');
        const deleteNoteBtnModal = document.getElementById('delete-note-btn-modal');

        // Authentication DOM elements (NEW)
        const authStatusSpan = document.getElementById('auth-status');
        const signInGoogleBtn = document.getElementById('sign-in-google-btn');
        const signOutBtn = document.getElementById('sign-out-btn');


        // --- Global State Variables ---
        let currentUserId = null;
        let currentListId = null;
        let currentListName = null;
        let videoCards = {}; // Stores { videoId: { element: DOM_Element, data: Object } }
        let sortableInstance = null; 
        let currentMenu = null; // To store the currently open 3-dots menu element
        let currentNoteVideoId = null; // To track which video's note is being edited

        // --- Utility Functions ---

        function showMessage(text, type = 'info', duration = 3000) {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('message', type);
            messageDiv.textContent = text;
            messageContainer.appendChild(messageDiv);

            setTimeout(() => messageDiv.classList.add('show'), 10);

            setTimeout(() => {
                messageDiv.classList.remove('show');
                messageDiv.addEventListener('transitionend', () => messageDiv.remove());
            }, duration);
        }

        function showLoading() {
            loadingOverlay.classList.add('active');
        }

        function hideLoading() {
            loadingOverlay.classList.remove('active');
        }

        function showModal(modalElement) {
            modalElement.classList.add('active');
            // Add event listener to close on escape key
            document.addEventListener('keydown', handleEscapeKey);
        }

        function hideModal(modalElement) {
            modalElement.classList.remove('active');
            // Remove event listener
            document.removeEventListener('keydown', handleEscapeKey);
        }

        function handleEscapeKey(e) {
            if (e.key === 'Escape') {
                const activeModals = document.querySelectorAll('.modal-overlay.active');
                if (activeModals.length > 0) {
                    // Close the topmost active modal
                    hideModal(activeModals[activeModals.length - 1]);
                }
            }
        }

        function debounce(func, delay) {
            let timeout;
            return function(...args) {
                const context = this;
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(context, args), delay);
            };
        }

        // --- Theme Management ---
        const LOCAL_STORAGE_THEME_KEY = 'youtube_organizer_theme';
        let mediaQueryList = null;

        function applyTheme(theme) {
            document.body.classList.remove('light-theme', 'dark-theme');

            if (mediaQueryList) {
                mediaQueryList.removeEventListener('change', handleSystemThemeChange);
                mediaQueryList = null;
            }

            if (theme === 'light') {
                document.body.classList.add('light-theme');
            } else if (theme === 'dark') {
                document.body.classList.add('dark-theme');
            } else { // System
                mediaQueryList = window.matchMedia('(prefers-color-scheme: light)');
                mediaQueryList.addEventListener('change', handleSystemThemeChange);
                handleSystemThemeChange(mediaQueryList);
            }
            localStorage.setItem(LOCAL_STORAGE_THEME_KEY, theme);
            themeModeSelector.value = theme;
        }

        function handleSystemThemeChange(e) {
            if (themeModeSelector.value === 'system') {
                if (e.matches) {
                    document.body.classList.add('light-theme');
                    document.body.classList.remove('dark-theme');
                } else {
                    document.body.classList.remove('light-theme');
                    document.body.classList.add('dark-theme');
                }
            }
        }

        // Initialize theme on page load
        const savedTheme = localStorage.getItem(LOCAL_STORAGE_THEME_KEY) || 'system';
        applyTheme(savedTheme);


        // --- Card Size Management ---
        const LOCAL_STORAGE_CARD_SIZE_KEY = 'youtube_organizer_card_size';

        function applyCardSize(size) {
            document.documentElement.style.setProperty('--card-base-width', `${size}px`);
            localStorage.setItem(LOCAL_STORAGE_CARD_SIZE_KEY, size);
            cardSizeSlider.value = size; // Update slider position
        }

        // Initialize card size on page load
        const savedCardSize = localStorage.getItem(LOCAL_STORAGE_CARD_SIZE_KEY) || cardSizeSlider.value; // Default to slider's HTML value
        applyCardSize(savedCardSize);
        cardSizeSlider.addEventListener('input', (e) => {
            applyCardSize(e.target.value);
        });


        // --- Firebase Authentication ---
        auth.onAuthStateChanged(user => {
            if (user) {
                currentUserId = user.uid;
                console.log("Firebase user logged in:", user.uid);
                authStatusSpan.textContent = `Logged in as: ${user.displayName || user.email || 'Anonymous'}`;
                signInGoogleBtn.style.display = 'none';
                signOutBtn.style.display = 'inline-block';
                loadLists(); // Load data for the logged-in user
                // Show list related buttons
                createListBtn.style.display = 'inline-flex'; // Assuming this is an icon-btn
            } else {
                currentUserId = null;
                currentListId = null; // Clear selected list
                currentListName = null;
                console.log("No user logged in.");
                authStatusSpan.textContent = 'Not logged in';
                signInGoogleBtn.style.display = 'inline-block'; // Show sign-in button
                signOutBtn.style.display = 'none';
                
                // Clear UI and show messages
                listsContainer.innerHTML = '<p style="text-align: center; color: var(--text-color); padding: 20px;">Please sign in to manage your lists.</p>';
                videoGridContainer.innerHTML = '<p style="text-align: center; color: var(--text-color); grid-column: 1 / -1;">Please sign in to view videos.</p>';
                
                // Hide list management buttons
                createListBtn.style.display = 'none';
                deleteListBtn.style.display = 'none';
                renameListBtn.style.display = 'none';
                
                // Destroy Sortable.js instance if any
                if (sortableInstance) {
                    sortableInstance.destroy();
                    sortableInstance = null;
                }
            }
        });

        // New Google Sign-In Function
        function signInWithGoogle() {
            showLoading();
            const provider = new firebase.auth.GoogleAuthProvider();
            // Optional: You can add scopes if you need access to user's Google data beyond basic profile
            // provider.addScope('https://www.googleapis.com/auth/youtube.readonly'); 
            firebase.auth().signInWithPopup(provider)
                .then((result) => {
                    // Sign-in successful, onAuthStateChanged will handle the rest
                    const user = result.user;
                    console.log("Google Sign-in successful:", user.uid);
                    showMessage(`Welcome, ${user.displayName || user.email}!`, 'success', 3000);
                })
                .catch((error) => {
                    // Handle Errors here.
                    const errorMessage = error.message;
                    console.error("Google Sign-in failed:", errorMessage);
                    showMessage(`Google Sign-in failed: ${errorMessage}. Please check console for details.`, 'error', 5000);
                })
                .finally(() => {
                    hideLoading();
                });
        }

        // New Sign Out Function
        function signOutUser() {
            showLoading();
            firebase.auth().signOut()
                .then(() => {
                    console.log("User signed out.");
                    showMessage("You have been signed out.", 'success', 2000);
                    // onAuthStateChanged will handle UI updates
                })
                .catch((error) => {
                    console.error("Error signing out:", error);
                    showMessage("Error signing out.", 'error');
                })
                .finally(() => {
                    hideLoading();
                });
        }


        // --- List Management ---
        function loadLists() {
            if (!currentUserId) return;
            showLoading();
            // Detach previous listener to avoid multiple callbacks
            db.ref(`users/${currentUserId}/lists`).off('value'); 

            db.ref(`users/${currentUserId}/lists`).on('value', snapshot => {
                listsContainer.innerHTML = '';
                const lists = snapshot.val();
                let hasLists = false;
                let firstListId = null;

                if (lists) {
                    const sortedListKeys = Object.keys(lists).sort((a, b) => lists[a].name.localeCompare(lists[b].name));
                    
                    sortedListKeys.forEach(listId => {
                        hasLists = true;
                        if (!firstListId) firstListId = listId;
                        const listItem = document.createElement('button');
                        listItem.classList.add('list-item');
                        listItem.setAttribute('data-id', listId);
                        listItem.textContent = lists[listId].name;
                        listItem.addEventListener('click', () => selectList(listId, lists[listId].name));
                        listsContainer.appendChild(listItem);
                    });
                }

                if (!hasLists) {
                    // Automatically create "My Videos" list if no lists exist
                    createNewList('My Videos');
                } else {
                    // Select first list if no current list or current list was deleted
                    if (!currentListId || !lists[currentListId]) {
                        selectList(firstListId, lists[firstListId].name);
                    } else {
                        // Re-select the active list to update its UI state
                        selectList(currentListId, currentListName);
                    }
                }
                updateDeleteListButtonVisibility();
                hideLoading();
            }, error => {
                console.error("Error loading lists:", error);
                showMessage("Failed to load your lists.", 'error');
                hideLoading();
            });
        }

        function selectList(listId, listName) {
            // Only re-render if a different list is selected
            if (currentListId === listId) { 
                updateActiveListClass(listId); 
                return; 
            }

            // Detach old video listener before changing list
            if (currentUserId && currentListId && videoListenerRef) {
                db.ref(`users/${currentUserId}/lists/${currentListId}/videos`).off('value');
            }
            // Destroy Sortable.js instance for old grid
            if (sortableInstance) {
                sortableInstance.destroy();
                sortableInstance = null;
            }

            currentListId = listId;
            currentListName = listName;
            updateActiveListClass(listId);
            updateDeleteListButtonVisibility();
            renderVideos();
        }

        function updateActiveListClass(activeId) {
            document.querySelectorAll('.list-item').forEach(item => {
                if (item.dataset.id === activeId) {
                    item.classList.add('active');
                } else {
                    item.classList.remove('active');
                }
            });
        }

        function createNewList(name) {
            if (!currentUserId) return;
            showLoading();
            const newListRef = db.ref(`users/${currentUserId}/lists`).push();
            newListRef.set({
                name: name,
                createdAt: firebase.database.ServerValue.TIMESTAMP
            }).then(() => {
                showMessage(`List "${name}" created successfully!`, 'success');
                hideModal(createListModal);
                listNameInput.value = '';
            }).catch(error => {
                console.error("Error creating list:", error);
                showMessage("Failed to create list.", 'error');
            }).finally(() => {
                hideLoading();
            });
        }

        function deleteCurrentList() {
            if (!currentUserId || !currentListId) return;

            // Prevent deleting the last list
            if (listsContainer.children.length <= 1) {
                showMessage("You cannot delete the last list. Create another one first if you wish to delete this one.", 'error', 5000);
                hideModal(confirmDeleteModal);
                return;
            }

            confirmDeleteMessage.textContent = `Are you sure you want to delete the list "${currentListName}" and all its videos? This action cannot be undone.`;
            showModal(confirmDeleteModal);
            confirmDeleteBtn.onclick = () => {
                showLoading();
                db.ref(`users/${currentUserId}/lists/${currentListId}`).remove()
                    .then(() => {
                        showMessage(`List "${currentListName}" deleted.`, 'success');
                        hideModal(confirmDeleteModal);
                        // The list listener will automatically re-render and select a new list
                    })
                    .catch(error => {
                        console.error("Error deleting list:", error);
                        showMessage("Failed to delete list.", 'error');
                    })
                    .finally(() => {
                        hideLoading();
                    });
            };
        }

        // Function to open rename modal (New)
        function openRenameListModal() {
            if (!currentListId || !currentListName) {
                showMessage("No list selected to rename.", 'error');
                return;
            }
            renameListNameInput.value = currentListName; // Pre-fill with current name
            showModal(renameListModal);
            renameListNameInput.focus();
        }

        // Function to submit rename (New)
        function renameCurrentList() {
            if (!currentUserId || !currentListId) return;
            const newName = renameListNameInput.value.trim();
            if (!newName) {
                showMessage("List name cannot be empty.", 'error');
                return;
            }
            if (newName === currentListName) {
                showMessage("New name is the same as the old name.", 'info');
                hideModal(renameListModal);
                return;
            }

            showLoading();
            db.ref(`users/${currentUserId}/lists/${currentListId}`).update({ name: newName })
                .then(() => {
                    showMessage(`List renamed to "${newName}" successfully!`, 'success');
                    currentListName = newName; // Update local state
                    hideModal(renameListModal);
                })
                .catch(error => {
                    console.error("Error renaming list:", error);
                    showMessage("Failed to rename list.", 'error');
                }).finally(() => {
                    hideLoading();
                });
        }

        function updateDeleteListButtonVisibility() {
            // Show delete and rename buttons only if there's more than one list and one is selected
            // Use listsContainer.children.length to accurately count rendered lists
            const numLists = listsContainer.querySelectorAll('.list-item').length; 
            if (currentUserId && numLists > 0 && currentListId) { // Ensure user is logged in
                deleteListBtn.style.display = numLists > 1 ? 'inline-block' : 'none'; // Only show delete if > 1 list
                renameListBtn.style.display = 'inline-block'; 
            } else {
                deleteListBtn.style.display = 'none';
                renameListBtn.style.display = 'none'; 
            }
        }

        // --- Video Management & API Calls ---

        // Cache for channel thumbnails to reduce API calls
        const channelThumbnailCache = {}; 

        // Utility to convert ISO 8601 duration (e.g., PT1H30M5S) to HH:MM:SS or MM:SS
        function formatDuration(isoDuration) {
            if (!isoDuration) return '';
            const regex = /PT(?:(\d+)H)?(?:(\d+)M)?(?:(\d+)S)?/;
            const matches = isoDuration.match(regex);
            let hours = parseInt(matches[1] || 0);
            let minutes = parseInt(matches[2] || 0);
            let seconds = parseInt(matches[3] || 0);

            if (hours > 0) {
                return `${hours}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            } else {
                return `${minutes}:${String(seconds).padStart(2, '0')}`;
            }
        }

        // Utility to format views (e.g., 354500 to 354.5K)
        function formatCount(count) {
            if (typeof count !== 'number') count = parseInt(count);
            if (isNaN(count)) return 'N/A';

            if (count >= 1000000000) return (count / 1000000000).toFixed(1) + 'B';
            if (count >= 1000000) return (count / 1000000).toFixed(1) + 'M';
            if (count >= 1000) return (count / 1000).toFixed(1) + 'K';
            return count.toLocaleString();
        }

        // Utility to format time ago (e.g., "3 days ago")
        function timeAgo(dateString) {
            if (!dateString) return 'N/A';
            const date = new Date(dateString);
            const now = new Date();
            const seconds = Math.floor((now - date) / 1000);

            let interval = seconds / 31536000; // Years
            if (interval > 1) return Math.floor(interval) + ' years ago';
            interval = seconds / 2592000; // Months
            if (interval > 1) return Math.floor(interval) + ' months ago';
            interval = seconds / 86400; // Days
            if (interval > 1) return Math.floor(interval) + ' days ago';
            interval = seconds / 3600; // Hours
            if (interval > 1) return Math.floor(interval) + ' hours ago';
            interval = seconds / 60; // Minutes
            if (interval > 1) return Math.floor(interval) + ' minutes ago';
            return Math.floor(seconds) + ' seconds ago';
        }


        async function getChannelThumbnail(channelId) {
            if (channelThumbnailCache[channelId]) {
                return channelThumbnailCache[channelId];
            }

            const cachedThumbnail = await db.ref(`channelThumbnails/${channelId}`).once('value');
            if (cachedThumbnail.exists() && cachedThumbnail.val().url) {
                channelThumbnailCache[channelId] = cachedThumbnail.val().url;
                return cachedThumbnail.val().url;
            }

            try {
                const response = await fetch(`https://www.googleapis.com/youtube/v3/channels?part=snippet&id=${channelId}&key=${YOUTUBE_API_KEY}`);
                const data = await response.json();

                if (!response.ok || data.items.length === 0 || !data.items[0].snippet || !data.items[0].snippet.thumbnails || !data.items[0].snippet.thumbnails.default) {
                    console.warn(`Could not get channel thumbnail for ${channelId}:`, data.error ? data.error.message : 'No items found or no default thumbnail.');
                    return '';
                }
                const thumbnailUrl = data.items[0].snippet.thumbnails.default.url;
                channelThumbnailCache[channelId] = thumbnailUrl;
                db.ref(`channelThumbnails/${channelId}`).set({ url: thumbnailUrl, fetchedAt: firebase.database.ServerValue.TIMESTAMP });
                return thumbnailUrl;
            } catch (error) {
                console.error("Error fetching channel thumbnail:", error);
                return '';
            }
        }


        async function getVideoDetails(youtubeUrl) {
            try {
                const videoIdMatch = youtubeUrl.match(/(?:https?:\/\/)?(?:www\.)?(?:m\.)?(?:youtube\.com|youtu\.be)\/(?:watch\?v=|embed\/|v\/|)([\w-]{11})(?:\S+)?/);
                if (!videoIdMatch || !videoIdMatch[1]) {
                    throw new Error('Invalid YouTube URL provided.');
                }
                const videoId = videoIdMatch[1];

                // Check if video already exists in current list
                if (currentListId && currentUserId) {
                    const videoExists = await db.ref(`users/${currentUserId}/lists/${currentListId}/videos`).orderByChild('youtubeId').equalTo(videoId).once('value');
                    if (videoExists.exists()) {
                        throw new Error('This video already exists in the current list.');
                    }
                }

                const videoResponse = await fetch(`https://www.googleapis.com/youtube/v3/videos?part=snippet,statistics,contentDetails&id=${videoId}&key=${YOUTUBE_API_KEY}`);
                const videoData = await videoResponse.json();

                if (!videoResponse.ok || videoData.items.length === 0) {
                    const errorMessage = videoData.error ? videoData.error.message : `Could not find video for ID: ${videoId}`;
                    console.error("YouTube API Error:", videoData.error);
                    throw new Error(`YouTube API Error: ${errorMessage}. Check your YouTube API Key and ensure "YouTube Data API v3" is enabled in your Google Cloud project.`);
                }

                const video = videoData.items[0];
                const snippet = video.snippet;
                const statistics = video.statistics;
                const contentDetails = video.contentDetails;

                const channelId = snippet.channelId;
                const channelThumbnail = await getChannelThumbnail(channelId);
                
                let subscriberCount = 'N/A';
                try {
                    const channelStatsResponse = await fetch(`https://www.googleapis.com/youtube/v3/channels?part=statistics&id=${channelId}&key=${YOUTUBE_API_KEY}`);
                    const channelStatsData = await channelStatsResponse.json();
                    if (channelStatsResponse.ok && channelStatsData.items.length > 0 && channelStatsData.items[0].statistics && channelStatsData.items[0].statistics.subscriberCount) {
                        subscriberCount = formatCount(parseInt(channelStatsData.items[0].statistics.subscriberCount));
                    }
                } catch (channelError) {
                    console.warn("Error fetching channel statistics for subscriber count:", channelError);
                }

                return {
                    youtubeId: videoId,
                    title: snippet.title,
                    thumbnail: snippet.thumbnails.high ? snippet.thumbnails.high.url : snippet.thumbnails.default.url,
                    views: formatCount(statistics.viewCount),
                    channelName: snippet.channelTitle,
                    channelThumbnailUrl: channelThumbnail,
                    duration: formatDuration(contentDetails.duration),
                    publishedAt: snippet.publishedAt,
                    subscribers: subscriberCount
                };

            } catch (error) {
                console.error("Error fetching video details:", error);
                throw error; // Re-throw to be caught by the caller
            }
        }

        async function addVideo(videoLink) {
            if (!videoLink) {
                showMessage("Please enter a YouTube video URL.", 'error');
                return;
            }

            if (!currentUserId || !currentListId) {
                showMessage("No list selected or user not authenticated. Please wait or create a list first.", 'error');
                return;
            }

            showLoading();
            try {
                const videoDetails = await getVideoDetails(videoLink);
                if (!videoDetails) { // Should not happen if getVideoDetails throws on error
                    showMessage("Failed to retrieve video details.", 'error');
                    return;
                }

                const newVideoRef = db.ref(`users/${currentUserId}/lists/${currentListId}/videos`).push();
                newVideoRef.set({
                    ...videoDetails,
                    order: -(new Date().getTime()), // Using negative timestamp for initial top sorting
                    timestamp: firebase.database.ServerValue.TIMESTAMP 
                }).then(() => {
                    showMessage("Video added successfully! You can drag it to reorder.", 'success', 4000);
                }).catch(error => {
                    console.error("Error adding video to database:", error);
                    showMessage("Failed to add video to database.", 'error');
                }).finally(() => {
                    hideLoading();
                });
            } catch (error) {
                showMessage(`Error adding video: ${error.message}`, 'error', 5000);
            } finally {
                hideLoading();
            }
        }

        let videoListenerRef = null;

        function renderVideos() {
            if (!currentUserId || !currentListId) {
                videoGridContainer.innerHTML = '<p style="text-align: center; color: var(--text-color); grid-column: 1 / -1;">Select or create a list to start adding videos.</p>';
                return;
            }

            videoGridContainer.innerHTML = ''; // Clear existing cards
            videoCards = {}; // Reset local cache of video cards
            if (sortableInstance) {
                sortableInstance.destroy();
                sortableInstance = null;
            }
            if (videoListenerRef) {
                videoListenerRef.off('value'); // Detach old listener
            }
            
            showLoading();
            const currentVideosRef = db.ref(`users/${currentUserId}/lists/${currentListId}/videos`);
            videoListenerRef = currentVideosRef;

            currentVideosRef.orderByChild('order').on('value', snapshot => {
                // Clear all children. All videos will be re-added below.
                Array.from(videoGridContainer.children).forEach(child => {
                    child.remove(); 
                });
                videoCards = {}; // Reset for fresh render

                const videos = [];
                snapshot.forEach(childSnapshot => {
                    const data = childSnapshot.val();
                    // Ensure 'order' field exists, assign a default negative timestamp if not
                    if (typeof data.order !== 'number' || data.order === null) {
                        data.order = data.timestamp ? -(new Date(data.timestamp).getTime()) : -(Date.now()); 
                        childSnapshot.ref.update({ order: data.order }); // Update Firebase
                    }
                    videos.push({ id: childSnapshot.key, ...data });
                });

                if (videos.length > 0) {
                    // Sorting is handled by Firebase orderByChild, but client-side sort for safety
                    videos.sort((a, b) => a.order - b.order); 

                    videos.forEach(video => {
                        const cardElement = createVideoCardElement(video.id, video);
                        videoGridContainer.appendChild(cardElement);
                        videoCards[video.id] = {
                            element: cardElement,
                            data: video
                        };
                    });
                } else {
                    const noVideosP = document.createElement('p');
                    noVideosP.style.cssText = 'text-align: center; color: var(--text-color); grid-column: 1 / -1;';
                    noVideosP.textContent = 'No videos in this list yet. Click "Add Video" in the header to get started!';
                    videoGridContainer.appendChild(noVideosP);
                }
                initializeSortable();
                hideLoading();
                // Apply search filter if active
                if (searchInput.value.trim() !== '') {
                    triggerSearch();
                }
            }, error => {
                console.error("Error loading videos:", error);
                showMessage("Failed to load videos for this list.", 'error');
                hideLoading();
            });
        }

        function createVideoCardElement(videoId, videoData) {
            const card = document.createElement('div');
            card.classList.add('video-card');
            card.setAttribute('data-id', videoId);
            card.setAttribute('data-title', (videoData.title || '').toLowerCase());
            card.setAttribute('data-channel', (videoData.channelName || '').toLowerCase());
            card.setAttribute('data-link', `https://www.youtube.com/watch?v=${videoData.youtubeId}`);
            
            const uploadedTime = videoData.publishedAt ? timeAgo(videoData.publishedAt) : 'N/A';
            const viewsText = videoData.views ? `${videoData.views} views` : 'N/A views';
            const subscribersText = videoData.subscribers ? `${videoData.subscribers} subs` : 'N/A subs';
            const channelAvatarSrc = videoData.channelThumbnailUrl || '';
            const hideAvatar = channelAvatarSrc === '' ? 'style="display:none;"' : '';

            const hasNote = videoData.note && videoData.note.trim() !== '';
            const noteButtonClass = hasNote ? 'open-note' : 'add-note';

            // Add 'has-note' class to the main card if a note exists for CSS visibility logic
            if (hasNote) { 
                card.classList.add('has-note');
            }

            card.innerHTML = `
                <div class="video-card-thumbnail">
                    <img src="${videoData.thumbnail}" alt="${videoData.title} thumbnail">
                    <span class="duration-overlay">${videoData.duration || ''}</span>
                    
                    <!-- Action buttons (Note & Three Dots) are now INSIDE thumbnail for positioning -->
                    <div class="video-card-action-buttons">
                        <button class="inline-note-btn ${noteButtonClass}" data-id="${videoId}" title="${hasNote ? 'Open Note' : 'Add Note'}">&#x1F4DD;</button>
                        <button class="three-dots-menu-btn" title="More options">...</button>
                    </div>
                </div>
                <div class="video-card-info-wrapper">
                    <img class="channel-avatar" src="${channelAvatarSrc}" alt="${videoData.channelName} avatar" ${hideAvatar}>
                    <div class="video-text-content">
                        <h3>${videoData.title}</h3>
                        <div class="video-card-meta">
                            <p class="channel-name">${videoData.channelName}</p>
                            <p>${viewsText}  ${subscribersText}  ${uploadedTime}</p>
                        </div>
                    </div>
                    <!-- video-menu-overlay remains here, it's displayed as a fixed overlay -->
                    <div class="video-menu-overlay">
                        <button class="menu-item view-btn" data-videoid="${videoData.youtubeId}">View Video</button>
                        <button class="menu-item delete-btn danger" data-id="${videoId}">Delete</button>
                    </div>
                </div>
            `;

            // Open video on thumbnail click (excluding clicks on action buttons themselves)
            card.querySelector('.video-card-thumbnail').addEventListener('click', (e) => {
                // Prevent opening video if click originated from action buttons
                if (e.target.closest('.video-card-action-buttons')) {
                    return;
                }
                window.open(`https://www.youtube.com/watch?v=${videoData.youtubeId}`, '_blank');
            });


            const menuButton = card.querySelector('.three-dots-menu-btn');
            const menuOverlay = card.querySelector('.video-menu-overlay');

            if (menuButton && menuOverlay) {
                menuButton.addEventListener('click', (e) => {
                    e.stopPropagation();
                    // Close any other open menu
                    if (currentMenu && currentMenu !== menuOverlay) {
                        currentMenu.classList.remove('active');
                        // When detaching, return menu to its original parent
                        const previousParent = currentMenu.dataset.originalParentId ? document.getElementById(currentMenu.dataset.originalParentId) : null;
                        if (previousParent) {
                             previousParent.appendChild(currentMenu);
                             currentMenu.removeAttribute('data-original-parent-id');
                        }
                    }
                    
                    // Position the menu
                    const rect = menuButton.getBoundingClientRect();
                    // Calculate position relative to the viewport
                    let menuLeft = rect.left; 
                    let menuTop = rect.bottom + 5; 

                    // Ensure menu doesn't go off screen to the right
                    if (menuLeft + menuOverlay.offsetWidth > window.innerWidth - 10) { 
                        menuLeft = window.innerWidth - menuOverlay.offsetWidth - 10;
                    }
                    // Ensure menu doesn't go off screen to the left
                    if (menuLeft < 10) {
                        menuLeft = 10;
                    }
                    
                    // Ensure menu doesn't go off screen to the bottom
                    if (menuTop + menuOverlay.offsetHeight > window.innerHeight - 10) { 
                         // Try to open upwards if space below is insufficient
                         menuTop = rect.top - menuOverlay.offsetHeight - 5;
                         // If still not enough space, or if it goes off top, fallback to 10px from top
                         if (menuTop < 10) { 
                            menuTop = 10;
                         }
                    }

                    menuOverlay.style.top = `${menuTop}px`;
                    menuOverlay.style.left = `${menuLeft}px`;

                    // Temporarily append to body to ensure it's on top and not cut off by card overflow
                    menuOverlay.dataset.originalParentId = menuOverlay.parentElement.id || ''; 
                    document.body.appendChild(menuOverlay);
                    menuOverlay.classList.toggle('active');
                    currentMenu = menuOverlay.classList.contains('active') ? menuOverlay : null;
                });
            }

            card.querySelector('.view-btn').addEventListener('click', (e) => {
                e.stopPropagation();
                if (currentMenu) {
                    currentMenu.classList.remove('active');
                    const previousParent = currentMenu.dataset.originalParentId ? document.getElementById(currentMenu.dataset.originalParentId) : null;
                    if (previousParent) { previousParent.appendChild(currentMenu); currentMenu.removeAttribute('data-original-parent-id'); }
                }
                window.open(`https://www.youtube.com/watch?v=${e.target.dataset.videoid}`, '_blank');
            });

            card.querySelector('.delete-btn').addEventListener('click', (e) => {
                e.stopPropagation();
                if (currentMenu) {
                    currentMenu.classList.remove('active');
                    const previousParent = currentMenu.dataset.originalParentId ? document.getElementById(currentMenu.dataset.originalParentId) : null;
                    if (previousParent) { previousParent.appendChild(currentMenu); currentMenu.removeAttribute('data-original-parent-id'); }
                }
                // Set the video ID for confirmation
                const videoIdToDelete = e.target.dataset.id;
                confirmDeleteMessage.textContent = `Are you sure you want to delete "${videoData.title}"?`;
                showModal(confirmDeleteModal);
                confirmDeleteBtn.onclick = () => {
                    showLoading();
                    db.ref(`users/${currentUserId}/lists/${currentListId}/videos/${videoIdToDelete}`).remove()
                        .then(() => {
                            showMessage("Video deleted.", 'success');
                            hideModal(confirmDeleteModal);
                        })
                        .catch(error => {
                            console.error("Error deleting video:", error);
                            showMessage("Failed to delete video.", 'error');
                        }).finally(() => {
                            hideLoading();
                        });
                };
            });

            // --- New Note Functionality ---
            const inlineNoteBtn = card.querySelector('.inline-note-btn');
            if (inlineNoteBtn) {
                inlineNoteBtn.addEventListener('click', (e) => {
                    e.stopPropagation(); // Stop click from propagating to thumbnail's open video event
                    openNoteEditModal(videoId);
                });
            }

            return card;
        }

        // --- Note Edit Modal Functions ---
        function openNoteEditModal(videoId) {
            if (!videoCards[videoId]) {
                showMessage("Video data not found.", 'error');
                return;
            }
            currentNoteVideoId = videoId;
            const video = videoCards[videoId].data;

            // Populate the video preview in the modal
            const uploadedTime = video.publishedAt ? timeAgo(video.publishedAt) : 'N/A';
            const viewsText = video.views ? `${video.views} views` : 'N/A views';

            noteVideoDetails.innerHTML = `
                <div class="note-modal-video-preview-thumbnail">
                    <img src="${video.thumbnail}" alt="${video.title} thumbnail">
                    <span class="duration-overlay">${video.duration || ''}</span>
                </div>
                <div class="note-modal-video-preview-info">
                    <h3>${video.title}</h3>
                    <p>${video.channelName}</p>
                    <p>${viewsText}  ${uploadedTime}</p>
                </div>
            `;
            noteModalTitle.textContent = "Edit Note"; // Generic title, video info is in preview

            noteTextareaModal.value = video.note || '';

            if (video.note && video.note.trim() !== '') {
                deleteNoteBtnModal.style.display = 'inline-block';
            } else {
                deleteNoteBtnModal.style.display = 'none';
            }
            showModal(noteEditModal);
            noteTextareaModal.focus(); // Focus on textarea when modal opens
        }

        function saveNoteFromModal() {
            if (!currentUserId || !currentListId || !currentNoteVideoId) {
                showMessage("Error: Missing data to save note.", 'error');
                return;
            }
            showLoading();
            const noteContent = noteTextareaModal.value.trim();
            db.ref(`users/${currentUserId}/lists/${currentListId}/videos/${currentNoteVideoId}/note`).set(noteContent === '' ? null : noteContent)
                .then(() => {
                    if (videoCards[currentNoteVideoId]) {
                        videoCards[currentNoteVideoId].data.note = noteContent; // Update local data
                        updateInlineNoteButton(currentNoteVideoId); // Update the card's note button and its parent .has-note class
                    }
                    showMessage("Note saved!", 'success', 1500);
                    hideModal(noteEditModal);
                }).catch(error => {
                    console.error("Error saving note:", error);
                    showMessage("Failed to save note.", 'error');
                }).finally(() => {
                    hideLoading();
                });
        }

        function deleteNoteFromModal() {
            if (!currentUserId || !currentListId || !currentNoteVideoId) {
                showMessage("Error: Missing data to delete note.", 'error');
                return;
            }
            // Add confirmation for delete note action
            confirmDeleteMessage.textContent = `Are you sure you want to delete the note for "${videoCards[currentNoteVideoId].data.title}"?`;
            showModal(confirmDeleteModal);
            confirmDeleteBtn.onclick = () => {
                showLoading();
                db.ref(`users/${currentUserId}/lists/${currentListId}/videos/${currentNoteVideoId}/note`).remove()
                    .then(() => {
                        if (videoCards[currentNoteVideoId]) {
                            videoCards[currentNoteVideoId].data.note = null; // Update local data
                            updateInlineNoteButton(currentNoteVideoId); // Update the card's note button and its parent .has-note class
                        }
                        showMessage("Note deleted!", 'success', 1500);
                        hideModal(noteEditModal); // Close note modal
                        hideModal(confirmDeleteModal); // Close confirm modal
                    }).catch(error => {
                        console.error("Error deleting note:", error);
                        showMessage("Failed to delete note.", 'error');
                    }).finally(() => {
                        hideLoading();
                    });
            };
        }

        function updateInlineNoteButton(videoId) {
            const cardElement = videoCards[videoId]?.element;
            if (!cardElement) return;

            const noteButton = cardElement.querySelector('.inline-note-btn');
            const hasNote = videoCards[videoId].data.note && videoCards[videoId].data.note.trim() !== '';

            // Update class on the note button itself
            if (noteButton) {
                noteButton.classList.remove('add-note', 'open-note');
                noteButton.classList.add(hasNote ? 'open-note' : 'add-note');
                noteButton.setAttribute('title', hasNote ? 'Open Note' : 'Add Note'); // Update title attribute
            }

            // Update 'has-note' class on the main video card
            // This is crucial for the visibility logic in CSS
            if (hasNote) {
                cardElement.classList.add('has-note');
            } else {
                cardElement.classList.remove('has-note');
            }
        }


        // --- Sortable.js Initialization and Update Logic ---
        function initializeSortable() {
            if (sortableInstance) {
                sortableInstance.destroy();
            }

            sortableInstance = Sortable.create(videoGridContainer, {
                animation: 150,
                group: 'videos',
                draggable: '.video-card', 
                handle: '.video-card-thumbnail', // Only thumbnail area is draggable handle
                filter: '.video-card-action-buttons', // Prevent dragging when clicking action buttons
                preventOnFilter: true, // Prevent the default drag and drop on filter elements
                
                onUpdate: function (evt) {
                    if (!currentUserId || !currentListId) {
                        showMessage("User not authenticated or no list selected. Cannot reorder.", 'error');
                        return;
                    }

                    const videoRefs = db.ref(`users/${currentUserId}/lists/${currentListId}/videos`);
                    const updates = {};

                    const newOrderIds = [];
                    Array.from(videoGridContainer.children).forEach(child => {
                        if (child.classList.contains('video-card')) {
                            newOrderIds.push(child.dataset.id);
                        }
                    });

                    // Assign new order values based on their current position
                    newOrderIds.forEach((id, index) => {
                        updates[id + '/order'] = index;
                    });

                    videoRefs.update(updates).then(() => {
                        console.log("Video order updated in Firebase.");
                        // The Firebase listener will re-render and sort
                    }).catch(error => {
                        console.error("Error updating video order:", error);
                        showMessage("Failed to update video order.", 'error');
                    });
                }
            });
        }


        // --- Search Functionality ---
        function triggerSearch() {
            const searchTerm = searchInput.value.toLowerCase().trim();
            for (const videoId in videoCards) {
                const card = videoCards[videoId].element;

                const title = card.dataset.title || '';
                const channel = card.dataset.channel || '';
                const link = card.dataset.link || '';

                if (title.includes(searchTerm) || channel.includes(searchTerm) || link.includes(searchTerm)) {
                    card.style.display = '';
                } else {
                    card.style.display = 'none';
                }
            }
            if (searchTerm === '') {
                // If search is cleared, ensure all cards are visible again
                Array.from(videoGridContainer.children).forEach(child => {
                    child.style.display = '';
                });
            }
        }
        searchInput.addEventListener('input', debounce(triggerSearch, 150));


        // --- Global Event Listeners ---

        // Close 3-dots menu if clicked outside
        document.addEventListener('click', (e) => {
            if (currentMenu && !e.target.closest('.video-menu-overlay') && !e.target.classList.contains('three-dots-menu-btn')) {
                currentMenu.classList.remove('active');
                // When detaching, return menu to its original parent
                const originalParentId = currentMenu.dataset.originalParentId;
                if (originalParentId) {
                    const previousParent = document.getElementById(originalParentId);
                    if (previousParent) {
                        previousParent.appendChild(currentMenu);
                        currentMenu.removeAttribute('data-original-parent-id');
                    }
                }
                currentMenu = null;
            }
        });


        // Modal close buttons (including the 'x' button)
        document.querySelectorAll('.cancel-btn').forEach(button => {
            button.addEventListener('click', (e) => {
                hideModal(e.target.closest('.modal-overlay'));
            });
        });

        // Add Video button in header
        addVideoButtonHeader.addEventListener('click', () => {
            if (!currentUserId) {
                showMessage("Please sign in to add videos.", 'error');
                return;
            }
            videoLinkInput.value = ''; // Clear input on open
            showModal(addVideoModal);
            videoLinkInput.focus(); // Focus input for quick paste
        });

        // Submit video button in modal
        submitVideoBtn.addEventListener('click', () => {
            addVideo(videoLinkInput.value);
            hideModal(addVideoModal); // Hide after initiating add process
            videoLinkInput.value = ''; // Clear input
        });

        // Enter key for adding video
        videoLinkInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                submitVideoBtn.click();
            }
        });

        // Create List button
        createListBtn.addEventListener('click', () => {
            if (!currentUserId) {
                showMessage("Please sign in to create lists.", 'error');
                return;
            }
            listNameInput.value = ''; // Clear input on open
            showModal(createListModal);
            listNameInput.focus();
        });

        // Submit List button in modal
        submitListBtn.addEventListener('click', () => {
            const listName = listNameInput.value.trim();
            if (listName) {
                createNewList(listName);
            } else {
                showMessage("List name cannot be empty.", 'error');
            }
        });

        // Enter key for creating list
        listNameInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                submitListBtn.click();
            }
        });

        // Delete Current List button
        deleteListBtn.addEventListener('click', deleteCurrentList);

        // Rename Current List button
        renameListBtn.addEventListener('click', openRenameListModal); 
        submitRenameListBtn.addEventListener('click', renameCurrentList); 
        renameListNameInput.addEventListener('keydown', (e) => { 
            if (e.key === 'Enter') {
                e.preventDefault();
                submitRenameListBtn.click();
            }
        });

        // Theme selector
        themeModeSelector.addEventListener('change', (e) => {
            applyTheme(e.target.value);
        });

        // Note modal buttons
        saveNoteBtnModal.addEventListener('click', saveNoteFromModal);
        noteTextareaModal.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && (e.ctrlKey || e.metaKey)) { // Ctrl+Enter or Cmd+Enter to save
                e.preventDefault();
                saveNoteFromModal();
            }
        });
        deleteNoteBtnModal.addEventListener('click', deleteNoteFromModal);

        // Event Listeners for NEW authentication buttons
        signInGoogleBtn.addEventListener('click', signInWithGoogle);
        signOutBtn.addEventListener('click', signOutUser);


        // --- Global Paste Listener (Ctrl+V functionality) ---
        document.body.addEventListener('paste', async (e) => {
            // Check if focus is on an input or textarea
            const activeElement = document.activeElement;
            if (activeElement && (activeElement.tagName === 'INPUT' || activeElement.tagName === 'TEXTAREA')) {
                return; // Let default paste handle it
            }

            const pastedText = (e.clipboardData || window.clipboardData).getData('text');
            const youtubeUrlRegex = /(?:https?:\/\/)?(?:www\.)?(?:m\.)?(?:youtube\.com|youtu\.be)\/(?:watch\?v=|embed\/|v\/|)([\w-]{11})(?:\S+)?/i; 

            if (youtubeUrlRegex.test(pastedText)) {
                e.preventDefault(); // Prevent default paste if it's a YouTube URL

                // Check if any modal is currently active
                const anyModalActive = document.querySelector('.modal-overlay.active');
                if (anyModalActive) {
                    showMessage("Please close the current popup before pasting a video link.", 'info', 3000);
                    return;
                }

                if (!currentListId) {
                    showMessage("Please select or create a list first to add videos.", 'error', 3000);
                    return;
                }

                // Fill the input and show the modal
                videoLinkInput.value = pastedText;
                showModal(addVideoModal);
                submitVideoBtn.focus(); // Focus the add button
            } else if (pastedText.trim() !== '') {
                // Optionally, show a message for non-YouTube URLs if desired, but user didn't ask for it
                // console.log("Pasted text is not a YouTube URL:", pastedText);
            }
        });


        // Initial render logic will be triggered by auth state change
    </script>
</body>
</html>
